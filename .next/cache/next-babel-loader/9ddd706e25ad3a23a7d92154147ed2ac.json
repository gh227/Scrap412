{"ast":null,"code":"import nextConnect from 'next-connect';\nimport isEmail from 'validator/lib/isEmail';\nimport normalizeEmail from 'validator/lib/normalizeEmail';\nimport bcrypt from 'bcryptjs';\nimport { nanoid } from 'nanoid';\nimport middleware from '../../middlewares/middleware';\nimport apimiddleware from '../../middlewares/apimiddleware';\nimport { extractUser } from '../../lib/api-helper';\nimport cors from 'cors';\nconst handler = nextConnect();\nhandler.use(apimiddleware).use(cors({\n  origin: process.env.HOST,\n  HttpOnly: true\n})).use(middleware);\n/*handler.get(async(req, res)=>{\n    console.log('request :' , req.headers[\"content-type\"])\n    if(req.headers('x-token') == 'ifactonews'){\n        res.send(req.db)}\n        else{\n            res.send(\"unauthorized\")\n        }\n        res.send('working')\n    });*/\n\nhandler.post(async (req, res) => {\n  const email = normalizeEmail(req.body.email);\n  console.log(req.body.email);\n  const {\n    name,\n    password\n  } = req.body;\n\n  if (!name) {\n    res.status(400).send(\"Name is  required\");\n    return;\n  }\n\n  if (!isEmail(email)) {\n    res.status(400).send(\"invalid email\");\n    return;\n  }\n\n  if (!password) {\n    res.status(400).send(\"Password is required\");\n    return;\n  }\n\n  if ((await req.db.collection('users').countDocuments({\n    email\n  })) > 0) {\n    res.status(400).send(\"Email already exist\");\n  }\n\n  const hashedPassword = await bcrypt.hash(password, 10);\n  const user = await req.db.collection('users').insertOne({\n    _id: nanoid(12),\n    name,\n    email,\n    password: hashedPassword,\n    admin: false,\n    isVerified: false\n  }).then(({\n    ops\n  }) => ops[0]);\n  req.logIn(user, err => {\n    if (err) throw err;\n    res.status(201).json({\n      user: extractUser(req)\n    });\n  });\n});\nexport default handler;","map":{"version":3,"sources":["c:/Users/hero/Documents/projects/Next/pages/api/users.js"],"names":["nextConnect","isEmail","normalizeEmail","bcrypt","nanoid","middleware","apimiddleware","extractUser","cors","handler","use","origin","process","env","HOST","HttpOnly","post","req","res","email","body","console","log","name","password","status","send","db","collection","countDocuments","hashedPassword","hash","user","insertOne","_id","admin","isVerified","then","ops","logIn","err","json"],"mappings":"AAAA,OAAOA,WAAP,MAAwB,cAAxB;AACA,OAAOC,OAAP,MAAoB,uBAApB;AACA,OAAOC,cAAP,MAA2B,8BAA3B;AACA,OAAOC,MAAP,MAAmB,UAAnB;AACA,SAASC,MAAT,QAAuB,QAAvB;AACA,OAAOC,UAAP,MAAuB,8BAAvB;AACA,OAAOC,aAAP,MAA0B,iCAA1B;AACA,SAASC,WAAT,QAA4B,sBAA5B;AACA,OAAOC,IAAP,MAAiB,MAAjB;AAEA,MAAMC,OAAO,GAAGT,WAAW,EAA3B;AAEAS,OAAO,CAACC,GAAR,CAAYJ,aAAZ,EAA2BI,GAA3B,CAA+BF,IAAI,CAAC;AAACG,EAAAA,MAAM,EAACC,OAAO,CAACC,GAAR,CAAYC,IAApB;AAA0BC,EAAAA,QAAQ,EAAC;AAAnC,CAAD,CAAnC,EAA+EL,GAA/E,CAAmFL,UAAnF;AAEA;;;;;;;;;;AAUAI,OAAO,CAACO,IAAR,CAAa,OAAOC,GAAP,EAAYC,GAAZ,KAAkB;AAE3B,QAAMC,KAAK,GAAGjB,cAAc,CAACe,GAAG,CAACG,IAAJ,CAASD,KAAV,CAA5B;AACAE,EAAAA,OAAO,CAACC,GAAR,CAAYL,GAAG,CAACG,IAAJ,CAASD,KAArB;AACA,QAAM;AAACI,IAAAA,IAAD;AAAOC,IAAAA;AAAP,MAAmBP,GAAG,CAACG,IAA7B;;AAEA,MAAG,CAACG,IAAJ,EAAS;AACLL,IAAAA,GAAG,CAACO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,mBAArB;AACA;AACH;;AACD,MAAG,CAACzB,OAAO,CAACkB,KAAD,CAAX,EAAmB;AACfD,IAAAA,GAAG,CAACO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,eAArB;AACA;AACH;;AACD,MAAG,CAACF,QAAJ,EAAa;AACTN,IAAAA,GAAG,CAACO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,sBAArB;AACA;AACH;;AAED,MAAI,OAAMT,GAAG,CAACU,EAAJ,CAAOC,UAAP,CAAkB,OAAlB,EAA2BC,cAA3B,CAA0C;AAACV,IAAAA;AAAD,GAA1C,CAAN,IAAyD,CAA7D,EAAgE;AAC5DD,IAAAA,GAAG,CAACO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,qBAArB;AACH;;AACD,QAAMI,cAAc,GAAG,MAAM3B,MAAM,CAAC4B,IAAP,CAAYP,QAAZ,EAAqB,EAArB,CAA7B;AACA,QAAMQ,IAAI,GAAG,MAAMf,GAAG,CAACU,EAAJ,CAAOC,UAAP,CAAkB,OAAlB,EAA2BK,SAA3B,CACf;AACIC,IAAAA,GAAG,EAAC9B,MAAM,CAAC,EAAD,CADd;AAEImB,IAAAA,IAFJ;AAGIJ,IAAAA,KAHJ;AAIIK,IAAAA,QAAQ,EAACM,cAJb;AAKIK,IAAAA,KAAK,EAAC,KALV;AAMIC,IAAAA,UAAU,EAAC;AANf,GADe,EASjBC,IATiB,CASZ,CAAC;AAACC,IAAAA;AAAD,GAAD,KAASA,GAAG,CAAC,CAAD,CATA,CAAnB;AAUArB,EAAAA,GAAG,CAACsB,KAAJ,CAAUP,IAAV,EAAiBQ,GAAD,IAAO;AACnB,QAAGA,GAAH,EAAQ,MAAMA,GAAN;AACRtB,IAAAA,GAAG,CAACO,MAAJ,CAAW,GAAX,EAAgBgB,IAAhB,CAAqB;AACjBT,MAAAA,IAAI,EAACzB,WAAW,CAACU,GAAD;AADC,KAArB;AAGH,GALD;AAMH,CAvCD;AAyCA,eAAeR,OAAf","sourcesContent":["import nextConnect from 'next-connect';\nimport isEmail from 'validator/lib/isEmail';\nimport normalizeEmail from 'validator/lib/normalizeEmail';\nimport bcrypt from 'bcryptjs';\nimport { nanoid } from 'nanoid';\nimport middleware from '../../middlewares/middleware';\nimport apimiddleware from '../../middlewares/apimiddleware'\nimport { extractUser } from '../../lib/api-helper';\nimport cors from 'cors'\n\nconst handler = nextConnect();\n\nhandler.use(apimiddleware).use(cors({origin:process.env.HOST, HttpOnly:true})).use(middleware);\n\n/*handler.get(async(req, res)=>{\n    console.log('request :' , req.headers[\"content-type\"])\n    if(req.headers('x-token') == 'ifactonews'){\n        res.send(req.db)}\n        else{\n            res.send(\"unauthorized\")\n        }\n        res.send('working')\n    });*/\n\nhandler.post(async (req, res)=>{\n    \n    const email = normalizeEmail(req.body.email)\n    console.log(req.body.email)\n    const {name, password} = req.body;\n    \n    if(!name){\n        res.status(400).send(\"Name is  required\")\n        return;\n    }\n    if(!isEmail(email)){\n        res.status(400).send(\"invalid email\")\n        return;\n    }\n    if(!password){\n        res.status(400).send(\"Password is required\")\n        return;\n    }\n\n    if((await req.db.collection('users').countDocuments({email})>0)){\n        res.status(400).send(\"Email already exist\")\n    }\n    const hashedPassword = await bcrypt.hash(password,10);\n    const user = await req.db.collection('users').insertOne(\n        {\n            _id:nanoid(12),\n            name,\n            email,\n            password:hashedPassword,\n            admin:false,\n            isVerified:false,\n        }\n    ).then(({ops})=>ops[0]);\n    req.logIn(user, (err)=>{\n        if(err) throw err;\n        res.status(201).json({\n            user:extractUser(req)\n        })\n    })\n})\n\nexport default handler;\n"]},"metadata":{},"sourceType":"module"}