{"ast":null,"code":"import nextConnect from 'next-connect';\nimport isEmail from 'validator/lib/isEmail';\nimport normalizeEmail from 'validator/lib/normalizeEmail';\nimport bcrypt from 'bcryptjs';\nimport { nanoid } from 'nanoid';\nimport middleware from '../../middlewares/middleware';\nimport { extractUser } from '../../lib/api-helper';\nimport Cors from 'cors';\nimport next, { NextApiRequest, NextApiResponse } from 'next';\nconst handler = nextConnect();\nconst cors = Cors({\n  methods: ['GET', 'HEAD']\n});\nvar whitelist = ['http://example1.com', 'http://example2.com'];\n\nvar corsOptionsDelegate = function (req, callback) {\n  var corsOptions;\n\n  if (whitelist.indexOf(req) !== -1) {\n    corsOptions = {\n      origin: true\n    }; // reflect (enable) the requested origin in the CORS response\n  } else {\n    corsOptions = {\n      origin: false\n    }; // disable CORS for this request\n  }\n\n  callback(null, corsOptions); // callback expects two parameters: error and options\n};\n\nhandler.use(middleware);\n\nfunction runMiddleware(req, res, fn) {\n  return new Promise((resolve, reject) => {\n    fn(req, res, result => {\n      if (result instanceof Error) {\n        return reject(result);\n      }\n\n      return resolve(result);\n    });\n  });\n}\n\nhandler.get('/api/users', async (req, res, next) => {\n  const result = await runMiddleware(req, res, cors);\n  console.log(result);\n}, async (req, res) => res.send(\"not working\"));\nhandler.post(async (req, res) => {\n  const email = normalizeEmail(req.body.email);\n  console.log(req.body.email);\n  const {\n    name,\n    password\n  } = req.body;\n\n  if (!name) {\n    res.status(400).send(\"Name is  required\");\n    return;\n  }\n\n  if (!isEmail(email)) {\n    res.status(400).send(\"invalid email\");\n    return;\n  }\n\n  if (!password) {\n    res.status(400).send(\"Password is required\");\n    return;\n  }\n\n  if ((await req.db.collection('users').countDocuments({\n    email\n  })) > 0) {\n    res.status(400).send(\"Email already exist\");\n  }\n\n  const hashedPassword = await bcrypt.hash(password, 10);\n  const user = await req.db.collection('users').insertOne({\n    _id: nanoid(12),\n    name,\n    email,\n    password: hashedPassword,\n    isVerified: false\n  }).then(({\n    ops\n  }) => ops[0]);\n  req.logIn(user, err => {\n    if (err) throw err;\n    res.status(201).json({\n      user: extractUser(req)\n    });\n  });\n});\nexport default handler;","map":{"version":3,"sources":["C:/Users/hero/Documents/projects/Next/pages/api/users.js"],"names":["nextConnect","isEmail","normalizeEmail","bcrypt","nanoid","middleware","extractUser","Cors","next","NextApiRequest","NextApiResponse","handler","cors","methods","whitelist","corsOptionsDelegate","req","callback","corsOptions","indexOf","origin","use","runMiddleware","res","fn","Promise","resolve","reject","result","Error","get","console","log","send","post","email","body","name","password","status","db","collection","countDocuments","hashedPassword","hash","user","insertOne","_id","isVerified","then","ops","logIn","err","json"],"mappings":"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","sourcesContent":["import nextConnect from 'next-connect';\nimport isEmail from 'validator/lib/isEmail';\nimport normalizeEmail from 'validator/lib/normalizeEmail';\nimport bcrypt from 'bcryptjs';\nimport { nanoid } from 'nanoid';\nimport middleware from '../../middlewares/middleware';\nimport { extractUser } from '../../lib/api-helper';\nimport Cors from 'cors'\nimport next, { NextApiRequest, NextApiResponse } from 'next';\n\nconst handler = nextConnect();\nconst cors = Cors({\n    methods: ['GET', 'HEAD'],\n  })\n\nvar whitelist = ['http://example1.com', 'http://example2.com']\nvar corsOptionsDelegate = function(req, callback) {\n  var corsOptions;\n  if (whitelist.indexOf(req) !== -1) {\n    corsOptions = { origin: true } // reflect (enable) the requested origin in the CORS response\n  } else {\n    corsOptions = { origin: false } // disable CORS for this request\n  }\n  callback(null, corsOptions) // callback expects two parameters: error and options\n}\n\n\nhandler.use(middleware);\n\nfunction runMiddleware(req, res, fn) {\n    return new Promise((resolve, reject) => {\n      fn(req, res, (result) => {\n        if (result instanceof Error) {\n          return reject(result)\n        }\n  \n        return resolve(result)\n      })\n    })\n  }\n\nhandler.get('/api/users', async(req, res, next)=>{\n   const result = await runMiddleware(req, res, cors)\n   console.log(result)\n}, async(req, res)=>res.send(\"not working\"));\n\nhandler.post(async (req, res)=>{\n    \n    const email = normalizeEmail(req.body.email)\n    console.log(req.body.email)\n    const {name, password} = req.body;\n    \n    if(!name){\n        res.status(400).send(\"Name is  required\")\n        return;\n    }\n    if(!isEmail(email)){\n        res.status(400).send(\"invalid email\")\n        return;\n    }\n    if(!password){\n        res.status(400).send(\"Password is required\")\n        return;\n    }\n\n    if((await req.db.collection('users').countDocuments({email})>0)){\n        res.status(400).send(\"Email already exist\")\n    }\n    const hashedPassword = await bcrypt.hash(password,10);\n    const user = await req.db.collection('users').insertOne(\n        {\n            _id:nanoid(12),\n            name,\n            email,\n            password:hashedPassword,\n            isVerified:false,\n        }\n    ).then(({ops})=>ops[0]);\n    req.logIn(user, (err)=>{\n        if(err) throw err;\n        res.status(201).json({\n            user:extractUser(req)\n        })\n    })\n})\n\nexport default handler;\n"]},"metadata":{},"sourceType":"module"}